/* Flux - generated by esbuild */
var f=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var A=(i,e)=>()=>(i&&(e=i(i=0)),e);var b=(i,e)=>{for(var t in e)f(i,t,{get:e[t],enumerable:!0})},C=(i,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of E(e))!I.call(i,n)&&n!==t&&f(i,n,{get:()=>e[n],enumerable:!(s=T(e,n))||s.enumerable});return i};var $=i=>C(f({},"__esModule",{value:!0}),i);var w={};b(w,{showInstallWarning:()=>N});function N(i){return new Promise(e=>{let t=!1,s=n=>{t||(t=!0,e(n))};new m(i,s).open()})}var v,D,m,x=A(()=>{v=require("obsidian"),D=`Flux will become the only source of truth for your vault.

After successful setup, all changes should go through Flux. Disable other sync solutions (e.g. iCloud, Dropbox, Obsidian Sync) for this vault.

By enabling Flux, you acknowledge that Flux will be the central source of truth.`,m=class extends v.Modal{constructor(t,s){super(t);this.onResult=s}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"Flux - Source of Truth"}),t.createEl("p",{text:D});let s=t.createDiv({cls:"flux-modal-buttons"});s.createEl("button",{text:"Cancel"}).onclick=()=>{this.onResult(!1),this.close()};let n=s.createEl("button",{text:"I understand, enable Flux"});n.addClass("mod-cta"),n.onclick=()=>{this.onResult(!0),this.close()}}onClose(){this.onResult(!1)}}});var O={};b(O,{default:()=>d});module.exports=$(O);var g=require("obsidian");var u=require("obsidian"),F={endpoint:"",username:"",password:"",syncIntervalSeconds:30,fluxFolder:"Flux",enabled:!1,acknowledgedWarning:!1};function k(i){return(i||"").trim().replace(/^\/|\/$/g,"")}var h=class extends u.PluginSettingTab{constructor(t,s){super(t,s);this.plugin=s}display(){let{containerEl:t,plugin:s}=this;t.empty();let n=a=>{Object.assign(s.settings,a),s.saveSettings()};new u.Setting(t).setName("Endpoint URL").setDesc("Flux server URL (e.g. https://flux.shaun.zip)").addText(a=>a.setPlaceholder("https://flux.example.com").setValue(s.settings.endpoint).onChange(l=>n({endpoint:l.trim()}))),new u.Setting(t).setName("Username").setDesc("Basic Auth username").addText(a=>a.setPlaceholder("username").setValue(s.settings.username).onChange(l=>n({username:l}))),new u.Setting(t).setName("Password").setDesc("Basic Auth password").addText(a=>a.setPlaceholder("password").setValue(s.settings.password).onChange(l=>n({password:l}))),new u.Setting(t).setName("Flux folder").setDesc("Only sync files in this folder (e.g. Flux). Empty = whole vault.").addText(a=>a.setPlaceholder("Flux").setValue(s.settings.fluxFolder).onChange(l=>n({fluxFolder:k(l||"")}))),new u.Setting(t).setName("Pull interval (seconds)").setDesc("How often to pull (default 30)").addText(a=>a.setPlaceholder("30").setValue(String(s.settings.syncIntervalSeconds)).onChange(l=>{let r=Number.parseInt(l,10);!Number.isNaN(r)&&r>0&&(n({syncIntervalSeconds:r}),s.restartPullInterval())})),new u.Setting(t).setName("Enable sync").setDesc("Flux will become the only source of truth.").addToggle(a=>a.setValue(s.settings.enabled).onChange(async l=>{if(l&&!s.settings.acknowledgedWarning){let{showInstallWarning:r}=await Promise.resolve().then(()=>(x(),w));if(!await r(this.app))return a.setValue(!1);n({acknowledgedWarning:!0})}n({enabled:l}),s.setSyncEnabled(l)}))}};var o=require("obsidian"),S="flux",R=500;function y(i){let e=0;for(let t=0;t<i.length;t++)e=(e<<5)-e+i.charCodeAt(t)|0;return`sha256:${Math.abs(e).toString(36)}${i.length}`}function U(i){return(i||"").trim().replace(/^\/|\/$/g,"")}function c(i){let e=i instanceof Error?i:new Error(String(i));return e.cause instanceof Error?e.cause.message:e.message}var p=class{constructor(e,t){this.pushDebounce=new Map;this.applyingPull=!1;this.abortController=null;this.settings=e,this.vault=t}updateSettings(e){this.settings=e}get baseUrl(){let e=this.settings.endpoint.trim();return e?(!e.startsWith("http://")&&!e.startsWith("https://")&&(e=`${e.startsWith("localhost")||e.startsWith("127.0.0.1")?"http":"https"}://${e}`),e.replace(/\/$/,"")):""}inScope(e){let t=U(this.settings.fluxFolder);return!t||e===t||e.startsWith(t+"/")}async api(e,t={}){if(!this.baseUrl)throw new Error("Flux endpoint not configured");let s={"Content-Type":"application/json",...t.headers},{username:n,password:a}=this.settings;return(n||a)&&(s.Authorization=`Basic ${btoa(`${n}:${a}`)}`),fetch(this.baseUrl+e,{...t,headers:s})}async pushFile(e){if(this.applyingPull||!this.settings.enabled||!this.baseUrl||e.extension!=="md"||!this.inScope(e.path))return;let t=e.path,s=this.pushDebounce.get(t);s&&clearTimeout(s),this.pushDebounce.set(t,setTimeout(async()=>{this.pushDebounce.delete(t);try{let n=await this.vault.read(e),a=await this.api("/push",{method:"POST",body:JSON.stringify({files:[{path:t,content:n,hash:y(n)}]})});if(!a.ok)throw new Error(`Push failed: ${a.status}`);new o.Notice(`Flux: pushed ${t}`)}catch(n){console.error("[Flux] push error:",n),new o.Notice(`Flux: push failed \u2014 ${c(n)}`)}},R))}async pushFiles(e){for(let t of e)await this.pushFile(t)}async pull(){var e;if(!(!this.settings.enabled||!this.baseUrl)){(e=this.abortController)==null||e.abort(),this.abortController=new AbortController;try{let t=await this.api("/pull",{method:"GET",signal:this.abortController.signal});if(!t.ok)throw new Error(`Pull failed: ${t.status}`);let s=await t.json();this.applyingPull=!0;let n=0,a=0;try{for(let l of s.deleted||[]){if(!this.inScope(l))continue;let r=this.vault.getAbstractFileByPath(l);r&&(await this.vault.delete(r),a++)}for(let l of s.files||[]){if(!this.inScope(l.path))continue;let r=this.vault.getAbstractFileByPath(l.path);if(r&&r instanceof o.TFile){let P=await this.vault.read(r);y(P)!==l.hash&&(await this.vault.modify(r,l.content,{origin:S}),n++)}else await this.vault.create(l.path,l.content,{origin:S}),n++}}finally{this.applyingPull=!1}new o.Notice(n||a?`Flux: pulled ${n} updated, ${a} deleted`:"Flux: pull complete (no changes)")}catch(t){if(t.name==="AbortError")return;console.error("[Flux] pull error:",t),new o.Notice(`Flux: pull failed \u2014 ${c(t)}`)}}}cancel(){var e;(e=this.abortController)==null||e.abort();for(let t of this.pushDebounce.values())clearTimeout(t);this.pushDebounce.clear()}handleCreate(e){e instanceof o.TFile&&this.pushFile(e)}handleModify(e){e instanceof o.TFile&&this.pushFile(e)}async handleRename(e,t){if(this.applyingPull||!this.settings.enabled||!this.baseUrl)return;let s=this.inScope(t),n=e instanceof o.TFile&&this.inScope(e.path);if(!s&&!n)return;let a=s?[t]:[],l=[];if(n){let r=await this.vault.read(e);l.push({path:e.path,content:r,hash:y(r)})}try{let r=await this.api("/push",{method:"POST",body:JSON.stringify({files:l,deleted:a})});if(!r.ok)throw new Error(`Push failed: ${r.status}`);new o.Notice(`Flux: synced rename \u2192 ${e.path}`)}catch(r){console.error("[Flux] rename push error:",r),new o.Notice(`Flux: rename failed \u2014 ${c(r)}`)}}async handleDelete(e){if(!(this.applyingPull||!this.settings.enabled||!this.baseUrl||!this.inScope(e.path)))try{let t=await this.api("/push",{method:"POST",body:JSON.stringify({files:[],deleted:[e.path]})});if(!t.ok)throw new Error(`Push failed: ${t.status}`);new o.Notice(`Flux: deleted ${e.path}`)}catch(t){console.error("[Flux] delete push error:",t),new o.Notice(`Flux: delete failed \u2014 ${c(t)}`)}}};var d=class extends g.Plugin{constructor(){super(...arguments);this.sync=null;this.pullInterval=null}async onload(){await this.loadSettings(),this.addCommand({id:"flux-pull",name:"Pull changes",callback:()=>this.pull()}),this.addCommand({id:"flux-push",name:"Push all changes",callback:()=>this.pushAll()}),this.addSettingTab(new h(this.app,this)),this.sync=new p(this.settings,this.app.vault),this.settings.enabled&&this.startSync()}onunload(){var t;(t=this.sync)==null||t.cancel(),this.clearPullInterval()}async loadSettings(){this.settings={...F,...await this.loadData()}}async saveSettings(){await this.saveData(this.settings)}setSyncEnabled(t){t?this.startSync():this.stopSync()}restartPullInterval(){this.clearPullInterval(),this.settings.enabled&&this.settings.syncIntervalSeconds>0&&(this.pullInterval=setInterval(()=>this.pull(),this.settings.syncIntervalSeconds*1e3))}async startSync(){if(!this.sync)return;this.sync.updateSettings(this.settings);let t=(this.settings.fluxFolder||"").trim().replace(/^\/|\/$/g,"");t&&!this.app.vault.getAbstractFileByPath(t)&&await this.app.vault.createFolder(t),await this.pull(),this.registerEvent(this.app.vault.on("create",s=>this.sync.handleCreate(s))),this.registerEvent(this.app.vault.on("modify",s=>this.sync.handleModify(s))),this.registerEvent(this.app.vault.on("rename",(s,n)=>this.sync.handleRename(s,n))),this.registerEvent(this.app.vault.on("delete",s=>this.sync.handleDelete(s))),this.restartPullInterval()}stopSync(){var t;(t=this.sync)==null||t.cancel(),this.clearPullInterval()}clearPullInterval(){this.pullInterval&&(clearInterval(this.pullInterval),this.pullInterval=null)}pull(){var t;return(t=this.sync)==null?void 0:t.pull()}async pushAll(){if(!this.sync)return;let t=this.app.vault.getMarkdownFiles().filter(s=>this.sync.inScope(s.path));await this.sync.pushFiles(t),new g.Notice("Flux: pushed all files")}};
